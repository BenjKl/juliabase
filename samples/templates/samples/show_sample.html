{# -*- indent-tabs-mode: nil -*- #}
{% extends "samples/base.html" %}
{% comment %}
This file is part of Chantal, the samples database.

Copyright (C) 2010 Forschungszentrum Jülich, Germany,
                   Marvin Goblet <m.goblet@fz-juelich.de>,
                   Torsten Bronger <t.bronger@fz-juelich.de>

You must not use, install, pass on, offer, sell, analyse, modify, or distribute
this software without explicit permission of the copyright holder.  If you have
received a copy of this software without the explicit permission of the
copyright holder, you must destroy it immediately and completely.
{% endcomment %}

{% load i18n %}
{% load chantal %}
{% load samples_extras %}

{% block local_scripts %}
<script type="text/javascript">
// <![CDATA[
$(function() {chantal.request("{% url samples.views.json_client.get_folded_processes sample_id=samples_and_processes.sample_context.sample.id %}?process_ids={{ samples_and_processes.get_all_process_ids|join:"," }}",
                               function(data) { for (var i=0; i < data.length; i++)
                                                { $("#process-body-" + data[i]).hide(); $("#process-short-body-" + data[i]).show(); }
                               });
              $("h2.process").click(function(event){var process_id = event.target.id.split('-')[2];
                                                    chantal.request("{% url samples.views.json_client.fold_process sample_id=samples_and_processes.sample_context.sample.id %}?process_id=" + process_id,
                                                    function(data) {if (data) {
                                                             $("#process-body-" + process_id).hide("fast");
                                                             $("#process-short-body-" + process_id).show("fast");
                                                         } else {
                                                             $("#process-body-" + process_id).show("fast");
                                                             $("#process-short-body-" + process_id).hide("fast");
                                                         }
                                                    });
                                                   })
              });
// ]]>
</script>
{% endblock %}

{% block content_title %}{% endblock %}

{% block frame_content %}
  {% for sample_start, sample, process in samples_and_processes %}
    {% if sample_start %}
      {% spaceless %}<h1>{% trans 'Sample “' %}{{ sample.sample }}{% trans '”' %}<span class="aliases">
      {% for alias in sample.sample.aliases.all %}
        alias <strong>{{ alias }}</strong> {% endfor %}</span>{% if sample.can_edit %}<a class="edit-icon"
           href="{% url samples.views.sample.edit sample_name=sample.sample.name %}?next={{ sample.sample.get_absolute_url|urlquote_plus }}"
                          ><img src="{{ STATIC_URL }}chantal/icons/pencil.png" alt="edit icon" title="{% trans 'edit' %}"
                                width="16" height="16"/></a>
        {% if sample.id_for_rename %}<a class="edit-icon"
           href="{% url samples.views.bulk_rename.bulk_rename %}?ids={{ sample.id_for_rename }}&amp;next={{ sample.sample.get_absolute_url|urlquote_plus }}"
    ><img src="{{ STATIC_URL }}chantal/icons/tag_blue.png" alt="give-name icon" title="{% trans 'give name' %}"
          width="16" height="16"/></a>
        {% endif %}
      {% endif %}
      {% if sample.can_add_process %}<a class="edit-icon" href="{% url samples.views.sample.add_process sample_name=sample.sample.name %}"
                                 ><img src="{{ STATIC_URL }}chantal/icons/cog_add.png" alt="add-process icon"
                                       title="{% trans 'add process' %}" width="16" height="16"/></a>{% endif %}
      {% if not sample.clearance %}<a class="edit-icon"
         href="{% url samples.views.sample.export sample_name=sample.sample.name %}?next={{ sample.sample.get_absolute_url|urlquote_plus }}"
         ><img src="{{ STATIC_URL }}chantal/icons/table.png" alt="export icon" width="16" height="16"
               title="{% trans 'export as table' %}"/></a>{% endif %}</h1>{% endspaceless %}

      <div class="screen-only" style="float: right"><a
              href="{% url samples.views.sample.data_matrix_code %}?data={{ sample.sample.id|urlquote_plus }}"
                                                       ><img width="40" height="40" style="display: block"
              alt="{% trans 'Data Matrix code' %}" src="{{ STATIC_URL }}samples/qrcode.png"/></a></div>
      {% block sample_details %}{# This block can be overridden in derived templates #}{% endblock %}
      {% if sample.clearance %}
        <p style="color: red">
          {% trans "You can see this sample only due to a clearance.  Therefore, some fields and processes are hidden." %}
        </p>
      {% endif %}
      {% with sample.clearance as clearance %}
        {% with sample.sample as sample %}
          <table>
            <tr>
              {% value_field sample.currently_responsible_person "user" %}
            </tr>
            {% if not clearance %}
              <tr>
              {% if sample.topic %}
                {% value_field sample.topic %}
              {% else %}
                <td class="label">{% verbose_name Sample.topic %}:</td>
                <td class="value">— <span style="color: red; font-weight: normal; margin-left: 1em"
                                          >({% trans 'Attention: Topicless samples may be viewed and edited by anyone.' %})</span></td>
              {% endif %}
              </tr>
            {% endif %}
            {% if sample.tags and not clearance %}
              <tr>
                {% value_field sample.tags %}
              </tr>
            {% endif %}
            {% if sample.purpose and not clearance %}
              <tr>
                {% value_field sample.purpose %}
              </tr>
            {% endif %}
            <tr>
              {% value_field sample.current_location %}
            </tr>
          </table>

          {% if not clearance %}
            {% with sample.series.count as number_of_sample_series %}
              {% with sample.series.all as sample_serieses %}
                {% if number_of_sample_series %}
                  <p>
                    {% blocktrans count number_of_sample_series as counter with sample_serieses.0 as first_series and sample_serieses.0.get_absolute_url as first_url %}
                      This sample is part of the sample series “<a href="{{ first_url }}">{{ first_series }}</a>”.
                    {% plural %}
                      This sample is part of the following sample series:  <!-- {{ first_url }}  {{ first_series }} -->
                    {% endblocktrans %}
                  </p>

                  {% ifnotequal number_of_sample_series 1 %}
                    <ul class="sample-series-list">
                      {% for sample_series in sample_serieses %}
                        <li><a href="{{ sample_series.get_absolute_url }}">{{ sample_series }}</a></li>
                      {% endfor %}
                    </ul>
                  {% endifnotequal %}
                {% endif %}
              {% endwith %}
            {% endwith %}
          {% endif %}
        {% endwith %}
      {% endwith %}
      <form method="post" action="">
        <table>
          <tr style="vertical-align: top">
            <td>{{ sample.is_my_sample_form.as_p }}</td>
            <td style="padding-left: 1em">
              <p class="submit-button"><input type="submit"/></p>
            </td>
          </tr>
        </table>
      </form>
    {% endif %}

    {% if process %}
      <div class="process">
        <p class="operator_and_timestamp">
          {% if process.operator|should_show %}
            {% spaceless %}
              {% if sample.clearance %}
                {{ process.operator|get_safe_operator_name }}
              {% else %}
                {{ process.operator|get_really_full_name }}
              {% endif %}
            {% endspaceless %},
          {% endif %}
          {{ process|timestamp }}
        </p>
        {% spaceless %}
          <h2 id="process-heading-{{ process.process.id }}" class="process" style="margin-bottom: 0ex">
            {{ process.name }}{% if process.edit_url %}<a class="edit-icon"
                                             href="{{ process.edit_url }}?next={{ sample.sample.get_absolute_url|urlquote_plus }}"
               ><img src="{{ STATIC_URL }}chantal/icons/cog_edit.png" alt="edit icon" title="{% trans 'edit' %}"
                     width="16" height="16"/></a>
            {% endif %}{% if process.duplicate_url %}<a class="edit-icon" href="{{ process.duplicate_url }}"
               ><img src="{{ STATIC_URL }}chantal/icons/cog_add.png" alt="add icon" title="{% trans 'duplicate' %}"
                     width="16" height="16"/></a>
            {% endif %}{% if process.export_url %}<a class="edit-icon"
                    href="{{ process.export_url }}?next={{ sample.sample.get_absolute_url|urlquote_plus }}"
               ><img src="{{ STATIC_URL }}chantal/icons/table.png" alt="export icon" title="{% trans 'export as table' %}"
                     width="16" height="16"/></a>
            {% endif %}{% if process.resplit_url %}<a class="edit-icon"
                     href="{{ process.resplit_url }}?next={{ sample.sample.get_absolute_url|urlquote_plus }}"
               ><img src="{{ STATIC_URL }}chantal/icons/arrow_branch.png" alt="resplit icon" title="{% trans 'resplit' %}"
                     width="16" height="16"/></a>
            {% endif %}
            {% if not process.process.finished %}<span style="margin-left: 2em; color: red; font-size: small"
                                                        >{% trans "(not finished)" %}</span>{% endif %}
          </h2>
        {% endspaceless %}
        <div style="margin-top:0.25em; overflow: auto{% if not process.process.finished %}; color: gray{% endif %}">
          <div id="process-body-{{ process.process.id }}">
            {{ process.html_body }}
          </div>
          {% if process.short_html_body %}
            <div id="process-short-body-{{ process.process.id }}" style="display: none">
              {{ process.short_html_body }}
            </div>
          {% endif %}
        </div>
      </div>
    {% endif %}
  {% endfor %}
{% endblock %}
